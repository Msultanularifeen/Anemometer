<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Anemometer Dashboard</title>
  <script src="https://cdn.tailwindcss.com"></script>
  <script src="https://cdnjs.cloudflare.com/ajax/libs/recharts/2.12.7/recharts.min.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-app-compat.js"></script>
  <script src="https://www.gstatic.com/firebasejs/9.6.10/firebase-database-compat.js"></script>

  <style>
    :root, .light {
      --background: 0 0% 100%;
      --foreground: 224 71.4% 4.1%;
      --card: 0 0% 100%;
      --card-foreground: 224 71.4% 4.1%;
      --primary: 220 9.1% 45.1%;
      --muted: 220 14.3% 95.9%;
      --muted-foreground: 220 8.9% 46.1%;
      --border: 220 13% 91%;
      --chart-1: 220 70% 50%;
    }
    .dark {
      --background: 224 71.4% 4.1%;
      --foreground: 210 20% 98%;
      --card: 224 71.4% 4.1%;
      --card-foreground: 210 20% 98%;
      --primary: 210 20% 98%;
      --muted: 215 27.9% 16.9%;
      --muted-foreground: 217.9 10.6% 64.9%;
      --border: 215 27.9% 16.9%;
      --chart-1: 220 70% 50%;
    }
    body { background-color: hsl(var(--background)); color: hsl(var(--foreground)); }
    .bg-background { background-color: hsl(var(--background)); }
    .bg-card { background-color: hsl(var(--card)); }
    .text-card-foreground { color: hsl(var(--card-foreground)); }
    .text-muted-foreground { color: hsl(var(--muted-foreground)); }
    .border-b { border-bottom-width: 1px; }
    .border-dashed { border-style: dashed; }
    .border-primary { border-color: hsl(var(--primary)); }
    .border-border { border-color: hsl(var(--border)); }
    .recharts-xAxis .recharts-text { fill: hsl(var(--muted-foreground)); }
    .recharts-yAxis .recharts-text { fill: hsl(var(--muted-foreground)); }
  </style>
</head>
<body class="bg-background font-sans antialiased">
  <div id="app-container">
    <div class="flex min-h-screen w-full flex-col bg-background">
      <header class="flex h-16 items-center justify-between gap-4 border-b border-border bg-card px-6 sticky top-0 z-50">
        <h1 class="text-xl font-semibold tracking-tight text-card-foreground">Anemometer</h1>
        <button id="theme-toggle" class="p-2 rounded-md hover:bg-gray-200 dark:hover:bg-gray-700">
          <svg id="theme-icon-light" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
          <svg id="theme-icon-dark" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-5 w-5" style="display: none;"><circle cx="12" cy="12" r="4"/><path d="M12 2v2"/><path d="M12 20v2"/><path d="m4.93 4.93 1.41 1.41"/><path d="m17.66 17.66 1.41 1.41"/><path d="M2 12h2"/><path d="M20 12h2"/><path d="m6.34 17.66-1.41 1.41"/><path d"m19.07 4.93-1.41 1.41"/></svg>
        </button>
      </header>
      <main class="flex-1 p-4 sm:p-6 md:p-8">
        <div id="error-alert" class="hidden items-center justify-center h-full">
           <div class="max-w-xl mx-auto border-red-500/50 text-red-500 p-4 rounded-lg border">
              <h2 class="font-medium leading-none tracking-tight">Connection Error</h2>
              <div id="error-message" class="text-sm"></div>
           </div>
        </div>
        <div id="dashboard-content" class="grid grid-cols-1 gap-6">
          <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
            <div class="border-dashed h-full transition-all duration-300 hover:border-primary hover:shadow-lg hover:-translate-y-1 rounded-lg border bg-card text-card-foreground shadow-sm p-6">
                <h3 class="text-sm font-medium text-muted-foreground">Current Speed</h3>
                <div class="text-2xl font-bold tracking-tighter text-card-foreground" id="current-speed">0.00 <span class="text-sm font-medium text-muted-foreground">km/h</span></div>
                <p class="text-xs text-muted-foreground">Latest reading from sensor</p>
            </div>
            <div class="border-dashed h-full transition-all duration-300 hover:border-primary hover:shadow-lg hover:-translate-y-1 rounded-lg border bg-card text-card-foreground shadow-sm p-6">
                <h3 class="text-sm font-medium text-muted-foreground">Average speed</h3>
                <div class="text-2xl font-bold tracking-tighter text-card-foreground" id="average-speed">0.00 <span class="text-sm font-medium text-muted-foreground">km/h</span></div>
                <p class="text-xs text-muted-foreground">Average of last 30 readings</p>
            </div>
            <div class="border-dashed h-full transition-all duration-300 hover:border-primary hover:shadow-lg hover:-translate-y-1 rounded-lg border bg-card text-card-foreground shadow-sm p-6">
                <h3 class="text-sm font-medium text-muted-foreground">Minimum Speed</h3>
                <div class="text-2xl font-bold tracking-tighter text-card-foreground" id="min-speed">0.00 <span class="text-sm font-medium text-muted-foreground">km/h</span></div>
                <p class="text-xs text-muted-foreground">Lowest reading</p>
            </div>
            <div class="border-dashed h-full transition-all duration-300 hover:border-primary hover:shadow-lg hover:-translate-y-1 rounded-lg border bg-card text-card-foreground shadow-sm p-6">
                <h3 class="text-sm font-medium text-muted-foreground">Maximum Speed</h3>
                <div class="text-2xl font-bold tracking-tighter text-card-foreground" id="max-speed">0.00 <span class="text-sm font-medium text-muted-foreground">km/h</span></div>
                <p class="text-xs text-muted-foreground">Highest reading</p>
            </div>
          </div>
          <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
            <div class="lg:col-span-2 rounded-lg border border-dashed bg-card text-card-foreground shadow-sm p-4">
              <h3 class="text-lg font-semibold text-card-foreground px-2">Real-time Wind Speed (Last 30 readings)</h3>
              <div id="chart-container" class="w-full h-96"></div>
            </div>
            <div class="lg:col-span-1">
                <div class="border-none shadow-none bg-transparent flex flex-col h-full rounded-lg bg-card text-card-foreground p-6">
                    <h3 class="text-lg font-semibold">A Project by BS Physics Students</h3>
                    <p class="text-sm text-muted-foreground">Batch 2024-2028</p>
                    <div class="flex-1 flex flex-col justify-center gap-4 mt-4">
                        <p><strong>Masoom Ali:</strong> Mechanical Work</p>
                        <p><strong>Muhammad Sultan Ul Arifeen:</strong> Programming & Electronics</p>
                        <p><strong>Website Designed & Developed By:</strong> Muhammad Sultan Ul Arifeen</p>
                    </div>
                </div>
            </div>
          </div>
        </div>
      </main>
    </div>
  </div>

  <script>
    // --- START: THEME ---
    const themeToggle = document.getElementById('theme-toggle');
    const lightIcon = document.getElementById('theme-icon-light');
    const darkIcon = document.getElementById('theme-icon-dark');
    
    if (localStorage.getItem('theme') === 'dark' || (!('theme' in localStorage) && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
        document.documentElement.classList.add('dark');
        darkIcon.style.display = 'block';
        lightIcon.style.display = 'none';
    } else {
        document.documentElement.classList.remove('dark');
        darkIcon.style.display = 'none';
        lightIcon.style.display = 'block';
    }

    themeToggle.addEventListener('click', () => {
        if (document.documentElement.classList.contains('dark')) {
            document.documentElement.classList.remove('dark');
            localStorage.setItem('theme', 'light');
            darkIcon.style.display = 'none';
            lightIcon.style.display = 'block';
        } else {
            document.documentElement.classList.add('dark');
            localStorage.setItem('theme', 'dark');
            darkIcon.style.display = 'block';
            lightIcon.style.display = 'none';
        }
    });
    // --- END: THEME ---
    
    
    // --- START: FIREBASE & CHART LOGIC ---
    let app;
    try {
        // --- START: Firebase Configuration ---
        const firebaseConfig = {
          apiKey: "AIzaSyAssOVvWLkzKMcL-kgyrlYNg05HEQUGBAo",
          authDomain: "anemometer-fgsd.firebaseapp.com",
          projectId: "anemometer-fgsd",
          appId: "1:474068960064:web:b4dc79e5112a18743b30a5",
          databaseURL: "https://anemometer-fgsd-default-rtdb.firebaseio.com",
          storageBucket: "anemometer-fgsd.appspot.com",
          messagingSenderId: "474068960064",
        };
        // --- END: Firebase Configuration ---

        if (!firebaseConfig.apiKey || firebaseConfig.apiKey.includes("YOUR_")) {
             throw new Error("Make sure you have replaced the placeholder API keys in the HTML file.");
        }

        app = firebase.initializeApp(firebaseConfig);
        const db = firebase.database();
        const readingsRef = db.ref("readings");

        const { AreaChart, Area, XAxis, YAxis, CartesianGrid, Tooltip, ResponsiveContainer } = Recharts;
        let chart;

        readingsRef.on("value", (snapshot) => {
            const data = snapshot.val();
            let history = [];
            if (data) {
                history = Object.values(data)
                    .map(d => ({
                        speed: typeof d.speed === 'number' ? d.speed : 0,
                        timestamp: typeof d.timestamp === 'number' ? d.timestamp : Date.now(),
                    }))
                    .sort((a, b) => a.timestamp - b.timestamp)
                    .slice(-30);
            }

            if (history.length < 30) {
                const placeholders = Array.from({ length: 30 - history.length }, (_, i) => ({
                    speed: 0,
                    timestamp: (history[0]?.timestamp || Date.now()) - (30 - history.length - i) * 1000,
                }));
                history = [...placeholders, ...history];
            }
             
            const chartData = history.map(d => ({
                ...d,
                time: new Date(d.timestamp).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
            }));

            const speeds = history.map(s => s.speed).filter(s => s > 0);
            const currentSpeed = history.length > 0 ? history[history.length - 1].speed : 0;
            const avgSpeed = speeds.length > 0 ? speeds.reduce((a, b) => a + b, 0) / speeds.length : 0;
            const minSpeed = speeds.length > 0 ? Math.min(...speeds) : 0;
            const maxSpeed = speeds.length > 0 ? Math.max(...speeds) : 0;

            document.getElementById('current-speed').innerHTML = `${currentSpeed.toFixed(2)} <span class="text-sm font-medium text-muted-foreground">km/h</span>`;
            document.getElementById('average-speed').innerHTML = `${avgSpeed.toFixed(2)} <span class="text-sm font-medium text-muted-foreground">km/h</span>`;
            document.getElementById('min-speed').innerHTML = `${minSpeed.toFixed(2)} <span class="text-sm font-medium text-muted-foreground">km/h</span>`;
            document.getElementById('max-speed').innerHTML = `${maxSpeed.toFixed(2)} <span class="text-sm font-medium text-muted-foreground">km/h</span>`;

            const yDomain = [0, Math.max(10, maxSpeed + 5)];
            const chartEl = React.createElement(ResponsiveContainer, { width: '100%', height: '100%' },
                React.createElement(AreaChart, { data: chartData, margin: { top: 5, right: 30, left: 0, bottom: 5 } },
                    React.createElement(defs, null, 
                      React.createElement('linearGradient', { id: 'colorUv', x1: '0', y1: '0', x2: '0', y2: '1' },
                        React.createElement('stop', { offset: '5%', stopColor: 'hsl(var(--chart-1))', stopOpacity: 0.8 }),
                        React.createElement('stop', { offset: '95%', stopColor: 'hsl(var(--chart-1))', stopOpacity: 0 })
                      )
                    ),
                    React.createElement(XAxis, { dataKey: 'time', stroke: 'hsl(var(--muted-foreground))', fontSize: 12 }),
                    React.createElement(YAxis, { domain: yDomain, stroke: 'hsl(var(--muted-foreground))', fontSize: 12 }),
                    React.createElement(Tooltip, { 
                        contentStyle: { 
                            backgroundColor: 'hsl(var(--background))',
                            borderColor: 'hsl(var(--border))'
                        } 
                    }),
                    React.createElement(Area, { type: 'monotone', dataKey: 'speed', stroke: 'hsl(var(--chart-1))', fillOpacity: 1, fill: 'url(#colorUv)' })
                )
            );
            ReactDOM.render(chartEl, document.getElementById('chart-container'));
            document.getElementById('dashboard-content').style.display = 'grid';
            document.getElementById('error-alert').style.display = 'none';

        }, (error) => {
            console.error(error);
            showError(error.message);
        });

    } catch (e) {
        console.error(e);
        showError(e.message);
    }
    
    function showError(message) {
        document.getElementById('dashboard-content').style.display = 'none';
        document.getElementById('error-alert').style.display = 'flex';
        document.getElementById('error-message').textContent = message;
    }
    // --- END: FIREBASE & CHART LOGIC ---
  </script>
</body>
</html>
