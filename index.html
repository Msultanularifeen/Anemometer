<!DOCTYPE html>
<html lang="en" class="dark">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Anemometer</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://unpkg.com/lucide@latest"></script>
    <script src="https://unpkg.com/recharts/umd/Recharts.min.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-app.js"></script>
    <script src="https://www.gstatic.com/firebasejs/9.6.1/firebase-database.js"></script>
    <style>
        :root {
            --background: 0 0% 100%;
            --foreground: 224 71.4% 4.1%;
            --card: 0 0% 100%;
            --card-foreground: 224 71.4% 4.1%;
            --popover: 0 0% 100%;
            --popover-foreground: 224 71.4% 4.1%;
            --primary: 220 9.1% 45.1%;
            --primary-foreground: 210 20% 98%;
            --secondary: 220 14.3% 95.9%;
            --secondary-foreground: 220.9 39.3% 11%;
            --muted: 220 14.3% 95.9%;
            --muted-foreground: 220 8.9% 46.1%;
            --accent: 220 14.3% 95.9%;
            --accent-foreground: 220.9 39.3% 11%;
            --destructive: 0 84.2% 60.2%;
            --destructive-foreground: 210 20% 98%;
            --border: 220 13% 91%;
            --input: 220 13% 91%;
            --ring: 224 71.4% 4.1%;
            --chart-1: 220 70% 50%;
            --radius: 0.5rem;
        }

        .dark {
            --background: 224 71.4% 4.1%;
            --foreground: 210 20% 98%;
            --card: 224 71.4% 4.1%;
            --card-foreground: 210 20% 98%;
            --popover: 224 71.4% 4.1%;
            --popover-foreground: 210 20% 98%;
            --primary: 210 20% 98%;
            --primary-foreground: 220.9 39.3% 11%;
            --secondary: 215 27.9% 16.9%;
            --secondary-foreground: 210 20% 98%;
            --muted: 215 27.9% 16.9%;
            --muted-foreground: 217.9 10.6% 64.9%;
            --accent: 215 27.9% 16.9%;
            --accent-foreground: 210 20% 98%;
            --destructive: 0 62.8% 30.6%;
            --destructive-foreground: 210 20% 98%;
            --border: 215 27.9% 16.9%;
            --input: 215 27.9% 16.9%;
            --ring: 216 12.2% 83.9%;
        }

        body {
            background-color: hsl(var(--background));
            color: hsl(var(--foreground));
        }

        .fade-in-animate {
            animation: fadeIn 0.5s ease-out forwards;
        }

        @keyframes fadeIn {
            from {
                opacity: 0;
                transform: translateY(10px);
            }
            to {
                opacity: 1;
                transform: translateY(0);
            }
        }
    </style>
</head>
<body class="font-sans antialiased">
    <div id="app-container" class="flex min-h-screen w-full flex-col bg-background" style="display: none;">
        <header class="flex h-16 items-center justify-between gap-4 border-b border-border bg-card px-6 sticky top-0 z-50">
            <div class="flex items-center gap-3">
                <h1 class="text-xl font-semibold tracking-tight text-card-foreground">Anemometer</h1>
            </div>
            <button id="theme-toggle" class="p-2 rounded-md hover:bg-accent">
                <svg id="sun-icon" xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-[1.2rem] w-[1.2rem]"><path d="M12 1v2m0 18v2M4.2 4.2l1.4 1.4m12.8 12.8 1.4 1.4M1 12h2m18 0h2M4.2 19.8l1.4-1.4M18.4 5.6l1.4-1.4"/></svg>
                <svg id="moon-icon" xmlns="http://www.w.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-[1.2rem] w-[1.2rem] hidden"><path d="M12 3a6 6 0 0 0 9 9 9 9 0 1 1-9-9Z"/></svg>
            </button>
        </header>
        <main class="flex-1 p-4 sm:p-6 md:p-8">
            <div id="error-container" style="display: none;" class="flex items-center justify-center h-[calc(100vh-12rem)] p-4">
                <div class="max-w-xl mx-auto border-destructive/50 text-destructive dark:border-destructive [&>svg]:text-destructive relative w-full rounded-lg border p-4 [&>svg~*]:pl-7 [&>svg+div]:translate-y-[-3px] [&>svg]:absolute [&>svg]:left-4 [&>svg]:top-4 [&>svg]:text-foreground">
                    <svg xmlns="http://www.w3.org/2000/svg" width="24" height="24" viewBox="0 0 24 24" fill="none" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round" class="h-4 w-4"><path d="m21.73 18-8-14a2 2 0 0 0-3.46 0l-8 14A2 2 0 0 0 4 21h16a2 2 0 0 0 1.73-3Z"/><path d="M12 9v4"/><path d="M12 17h.01"/></svg>
                    <h5 class="mb-1 font-medium leading-none tracking-tight">Connection Error</h5>
                    <div id="error-message" class="text-sm [&_p]:leading-relaxed"></div>
                </div>
            </div>

            <div id="dashboard-container" class="grid grid-cols-1 gap-6">
                <div class="grid grid-cols-1 sm:grid-cols-2 lg:grid-cols-4 gap-6">
                    <!-- SpeedDisplay Cards -->
                    <div id="current-speed-card" class="fade-in-animate" style="animation-delay: 100ms;"></div>
                    <div id="average-speed-card" class="fade-in-animate" style="animation-delay: 200ms;"></div>
                    <div id="min-speed-card" class="fade-in-animate" style="animation-delay: 300ms;"></div>
                    <div id="max-speed-card" class="fade-in-animate" style="animation-delay: 400ms;"></div>
                </div>
                <div class="grid grid-cols-1 lg:grid-cols-3 gap-6">
                    <div class="lg:col-span-2 fade-in-animate" style="animation-delay: 500ms;">
                        <div class="h-full flex flex-col border-dashed rounded-lg border bg-card text-card-foreground shadow-sm">
                            <div class="flex flex-col space-y-1.5 p-6">
                                <h3 class="text-lg font-semibold leading-none tracking-tight text-card-foreground">Real-time Wind Speed (Last 30 readings)</h3>
                            </div>
                            <div class="flex-1 -mt-4 p-6 pt-0">
                                <div id="speed-chart" class="h-[350px] w-full"></div>
                            </div>
                        </div>
                    </div>
                    <div class="lg:col-span-1 fade-in-animate" style="animation-delay: 600ms;">
                        <div id="credits-card"></div>
                    </div>
                </div>
            </div>
        </main>
    </div>

    <script>
        // --- START: THEME TOGGLE LOGIC ---
        const themeToggle = document.getElementById('theme-toggle');
        const sunIcon = document.getElementById('sun-icon');
        const moonIcon = document.getElementById('moon-icon');
        const htmlEl = document.documentElement;

        function setDarkTheme() {
            htmlEl.classList.add('dark');
            sunIcon.style.display = 'none';
            moonIcon.style.display = 'block';
            localStorage.setItem('theme', 'dark');
        }

        function setLightTheme() {
            htmlEl.classList.remove('dark');
            sunIcon.style.display = 'block';
            moonIcon.style.display = 'none';
            localStorage.setItem('theme', 'light');
        }

        // Apply theme on initial load
        const savedTheme = localStorage.getItem('theme');
        if (savedTheme === 'dark' || (!savedTheme && window.matchMedia('(prefers-color-scheme: dark)').matches)) {
            setDarkTheme();
        } else {
            setLightTheme();
        }

        themeToggle.addEventListener('click', () => {
            if (htmlEl.classList.contains('dark')) {
                setLightTheme();
            } else {
                setDarkTheme();
            }
        });
        // --- END: THEME TOGGLE LOGIC ---

        // --- START: UI RENDERING FUNCTIONS ---
        const renderSpeedCard = (id, title, speed, subtitle, icon, isPrimary = true) => {
            const container = document.getElementById(id);
            const iconEl = icon === 'Zap' ? `<i data-lucide="zap" class="h-4 w-4 text-gray-500 dark:text-gray-400"></i>` : `<i data-lucide="activity" class="h-4 w-4 text-gray-500 dark:text-gray-400"></i>`;
            container.innerHTML = `
                <div class="border-dashed h-full transition-all duration-300 hover:border-primary hover:shadow-lg hover:-translate-y-1 rounded-lg border bg-card text-card-foreground shadow-sm p-6">
                    <div class="flex flex-row items-center justify-between space-y-0 pb-2">
                        <h3 class="text-sm font-medium text-muted-foreground">${title}</h3>
                        ${iconEl}
                    </div>
                    <div>
                        <div class="text-2xl font-bold tracking-tighter text-card-foreground">${speed.toFixed(2)} <span class="text-sm font-medium text-muted-foreground">km/h</span></div>
                        <p class="text-xs text-muted-foreground">${subtitle}</p>
                    </div>
                </div>
            `;
        };

        const renderCreditsCard = () => {
            const container = document.getElementById('credits-card');
            container.innerHTML = `
                <div class="border-none shadow-none bg-transparent flex flex-col h-full rounded-lg bg-card text-card-foreground">
                    <div class="p-6 pb-4">
                        <div class="flex items-center gap-3 mb-2">
                            <i data-lucide="users" class="h-6 w-6 text-primary"></i>
                            <h3 class="text-lg font-semibold">A Project by BS Physics Students</h3>
                        </div>
                        <p class="text-sm text-muted-foreground">Batch 2024-2028</p>
                    </div>
                    <div class="p-6 pt-0 flex-1 flex flex-col justify-between">
                        <div class="flex flex-col gap-3">
                            <div class="flex items-start gap-3">
                                <div class="bg-primary/10 p-2 rounded-full"><i data-lucide="briefcase" class="h-4 w-4 text-primary"></i></div>
                                <div><p class="text-sm font-semibold">Masoom Ali</p><p class="text-xs text-muted-foreground">Mechanical Work</p></div>
                            </div>
                            <div class="flex items-start gap-3">
                                <div class="bg-primary/10 p-2 rounded-full"><i data-lucide="code" class="h-4 w-4 text-primary"></i></div>
                                <div><p class="text-sm font-semibold">Muhammad Sultan Ul Arifeen</p><p class="text-xs text-muted-foreground">Programming & Electronics</p></div>
                            </div>
                            <div class="flex items-start gap-3">
                                <div class="bg-primary/10 p-2 rounded-full"><i data-lucide="shield" class="h-4 w-4 text-primary"></i></div>
                                <div><p class="text-sm font-semibold">Website Designed & Developed By</p><p class="text-xs text-muted-foreground">Muhammad Sultan Ul Arifeen</p></div>
                            </div>
                        </div>
                        <div class="mt-4">
                            <hr class="my-3 border-border"/>
                            <div class="flex items-center gap-3 mb-2"><i data-lucide="award" class="h-5 w-5 text-amber-500"></i><p class="text-sm font-semibold">Special Thanks</p></div>
                            <div class="text-xs text-muted-foreground space-y-1"><p>Principal Azhar Kaisar</p><p>Professor Muhammad Farooq Ibadat</p></div>
                        </div>
                    </div>
                </div>
            `;
        }
        // --- END: UI RENDERING FUNCTIONS ---


        // --- START: FIREBASE AND APP LOGIC ---
        document.addEventListener('DOMContentLoaded', () => {
            try {
                // --- START: Firebase Configuration ---
                const firebaseConfig = {
                  "apiKey": "AIzaSyAssOVvWLkzKMcL-kgyrlYNg05HEQUGBAo",
                  "authDomain": "anemometer-fgsd.firebaseapp.com",
                  "databaseURL": "https://anemometer-fgsd-default-rtdb.firebaseio.com",
                  "projectId": "anemometer-fgsd",
                  "storageBucket": "anemometer-fgsd.appspot.com",
                  "messagingSenderId": "474068960064",
                  "appId": "1:474068960064:web:b4dc79e5112a18743b30a5"
                };
                // --- END: Firebase Configuration ---

                // Basic validation
                if (!firebaseConfig.apiKey || firebaseConfig.apiKey.includes("YOUR")) {
                    throw new Error("Make sure you have replaced the placeholder API keys in the HTML file.");
                }

                const app = firebase.initializeApp(firebaseConfig);
                const db = firebase.database();
                const readingsRef = db.ref("readings");

                document.getElementById('app-container').style.display = 'flex';
                renderCreditsCard(); // Render static cards
                lucide.createIcons();


                const { AreaChart, Area, XAxis, YAxis, Tooltip, ResponsiveContainer, CartesianGrid } = Recharts;

                const renderChart = (data) => {
                    const chartContainer = document.getElementById('speed-chart');
                    chartContainer.innerHTML = ''; // Clear previous chart

                    const isDark = document.documentElement.classList.contains('dark');
                    const axisColor = isDark ? '#FFFFFF' : '#666666';

                    const chart = React.createElement(ResponsiveContainer, { width: '100%', height: '100%' },
                        React.createElement(AreaChart, { data: data, margin: { top: 5, right: 20, left: -10, bottom: 5 } },
                            React.createElement('defs', null,
                                React.createElement('linearGradient', { id: 'colorSpeed', x1: '0', y1: '0', x2: '0', y2: '1' },
                                    React.createElement('stop', { offset: '5%', stopColor: 'hsl(var(--chart-1))', stopOpacity: 0.8 }),
                                    React.createElement('stop', { offset: '95%', stopColor: 'hsl(var(--chart-1))', stopOpacity: 0 })
                                )
                            ),
                            React.createElement(XAxis, { dataKey: "time", stroke: axisColor, fontSize: 12, tickLine: false, axisLine: false }),
                            React.createElement(YAxis, { stroke: axisColor, fontSize: 12, tickLine: false, axisLine: false, domain: [0, 'dataMax + 5'] }),
                            React.createElement(Tooltip, {
                                contentStyle: {
                                    backgroundColor: isDark ? 'hsl(var(--background))' : 'hsl(var(--background))',
                                    border: '1px solid hsl(var(--border))',
                                    color: 'hsl(var(--foreground))'
                                },
                                itemStyle: { color: 'hsl(var(--foreground))' },
                                labelStyle: { color: 'hsl(var(--muted-foreground))' }
                            }),
                            React.createElement(Area, { type: 'monotone', dataKey: 'speed', stroke: 'hsl(var(--chart-1))', fillOpacity: 1, fill: 'url(#colorSpeed)' })
                        )
                    );
                    ReactDOM.render(chart, chartContainer);
                };


                onValue(readingsRef, (snapshot) => {
                    const data = snapshot.val();
                    let history = [];
                    if (data) {
                        history = Object.values(data)
                            .map(d => ({
                                speed: typeof d.speed === "number" ? d.speed : 0,
                                timestamp: typeof d.timestamp === "number" ? d.timestamp : Date.now(),
                                time: new Date(d.timestamp || Date.now()).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                            }))
                            .sort((a, b) => a.timestamp - b.timestamp)
                            .slice(-30);
                    } else {
                        // Create placeholder data if db is empty
                        history = Array.from({ length: 30 }, (_, i) => ({
                            speed: 0,
                            timestamp: Date.now() - (30 - i) * 1000,
                            time: new Date(Date.now() - (30 - i) * 1000).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }),
                        }));
                    }

                    const speeds = history.map(s => s.speed);
                    const validSpeeds = speeds.filter(s => s > 0);

                    const currentSpeed = speeds.length > 0 ? speeds[speeds.length - 1] : 0;
                    const averageSpeed = validSpeeds.length > 0 ? validSpeeds.reduce((acc, curr) => acc + curr, 0) / validSpeeds.length : 0;
                    const minSpeed = validSpeeds.length > 0 ? Math.min(...validSpeeds) : 0;
                    const maxSpeed = validSpeeds.length > 0 ? Math.max(...validSpeeds) : 0;

                    // Render cards
                    renderSpeedCard('current-speed-card', 'Current Speed', currentSpeed, 'Latest reading from sensor', 'Zap');
                    renderSpeedCard('average-speed-card', 'Average Speed', averageSpeed, 'Average of last 30 readings', 'Activity');
                    renderSpeedCard('min-speed-card', 'Minimum Speed', minSpeed, 'Lowest reading', 'Zap', false);
                    renderSpeedCard('max-speed-card', 'Maximum Speed', maxSpeed, 'Highest reading', 'Activity');

                    // Render chart
                    renderChart(history);

                    // Update all icons
                    lucide.createIcons();

                }, (error) => {
                    console.error("Firebase read failed:", error);
                    document.getElementById('dashboard-container').style.display = 'none';
                    const errorContainer = document.getElementById('error-container');
                    document.getElementById('error-message').innerText = "Failed to connect to the data stream. Please check your Firebase setup and security rules.";
                    errorContainer.style.display = 'flex';
                });

            } catch (e) {
                console.error("Initialization failed:", e);
                document.getElementById('dashboard-container').style.display = 'none';
                const errorContainer = document.getElementById('error-container');
                document.getElementById('error-message').innerText = e.message;
                errorContainer.style.display = 'flex';
            }
        });
        // --- END: FIREBASE AND APP LOGIC ---
    </script>
    <!-- Dependencies for Recharts - These need to be loaded for the chart to work -->
    <script src="https://unpkg.com/react@17/umd/react.production.min.js"></script>
    <script src="https://unpkg.com/react-dom@17/umd/react-dom.production.min.js"></script>
</body>
</html>

    
